-- migrate:up

-- This table is used to store the next event to be processed by an FSM instance.
-- The next event can be enqueued by the FSM itself while a transition is in progress.
CREATE TABLE fsm_next_event (
    id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() AT TIME ZONE 'utc'),
    fsm_instance_id BIGINT UNIQUE NOT NULL REFERENCES fsm_instances(id) ON DELETE CASCADE,
    next_state schema_ref NOT NULL,
    request BYTEA NOT NULL,
    request_type schema_type NOT NULL,
    UNIQUE (fsm_instance_id, next_state)
);


-- migrate:down

