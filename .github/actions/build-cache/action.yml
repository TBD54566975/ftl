name: Build Cache
description: Cache builds
runs:
  using: "composite"
  # Make sure to keep these cache entries in sync with those in writecache.yml
  steps:
    - id: reset-timestamps
      shell: bash
      run: git ls-files -z | xargs -0 touch -r go.mod
    - id: find-go-build-cache
      shell: bash
      run: echo "cache=$(go env GOCACHE)" >> $GITHUB_OUTPUT
    - id: bin-hash
      shell: bash
      run: |
        hash="$(find ./${{ inputs.working-directory }}/bin ! -type d | sort | xargs openssl sha256 | openssl sha256 -r | cut -d' ' -f1)"
        echo "hash=$hash" >> "$GITHUB_OUTPUT"
    - name: Restore Hermit Cache
      uses: actions/cache/restore@v4
      with:
        path: ${{ runner.os == 'macOS' && '~/Library/Caches/hermit/pkg' || '~/.cache/hermit/pkg' }}
        key: ${{ runner.os }}-hermit-cache-${{ steps.bin-hash.outputs.hash }}
        restore-keys: |
          ${{ runner.os }}-hermit-cache-${{ steps.bin-hash.outputs.hash }}
          ${{ runner.os }}-hermit-cache-
    - name: Restore Go Modules Cache
      id: cache-go-modules
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/go/pkg/mod
          ${{ steps.find-go-build-cache.outputs.cache }}
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          ${{ runner.os }}-
    - name: Restore Maven Modules Cache
      id: cache-maven
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          ${{ runner.os }}-maven-
    - name: Restore pnpm Cache
      id: cache-pnpm
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.pnpm-store
          node_modules
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
