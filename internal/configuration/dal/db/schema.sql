SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: pgcrypto; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA public;


--
-- Name: EXTENSION pgcrypto; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION pgcrypto IS 'cryptographic functions';


--
-- Name: async_call_state; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.async_call_state AS ENUM (
    'pending',
    'executing',
    'success',
    'error'
);


--
-- Name: controller_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.controller_key AS text;


--
-- Name: controller_state; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.controller_state AS ENUM (
    'live',
    'dead'
);


--
-- Name: cron_job_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.cron_job_key AS text;


--
-- Name: deployment_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.deployment_key AS text;


--
-- Name: encrypted_async; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.encrypted_async AS bytea;


--
-- Name: encrypted_timeline; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.encrypted_timeline AS bytea;


--
-- Name: event_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.event_type AS ENUM (
    'call',
    'log',
    'deployment_created',
    'deployment_updated',
    'ingress'
);


--
-- Name: fsm_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.fsm_status AS ENUM (
    'running',
    'completed',
    'failed'
);


--
-- Name: lease_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.lease_key AS text;


--
-- Name: module_schema_pb; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.module_schema_pb AS bytea;


--
-- Name: origin; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.origin AS ENUM (
    'ingress',
    'cron',
    'pubsub'
);


--
-- Name: request_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.request_key AS text;


--
-- Name: runner_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.runner_key AS text;


--
-- Name: schema_ref; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.schema_ref AS text;


--
-- Name: schema_type; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.schema_type AS bytea;


--
-- Name: subscriber_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.subscriber_key AS text;


--
-- Name: subscription_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.subscription_key AS text;


--
-- Name: topic_event_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.topic_event_key AS text;


--
-- Name: topic_key; Type: DOMAIN; Schema: public; Owner: -
--

CREATE DOMAIN public.topic_key AS text;


--
-- Name: topic_subscription_state; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.topic_subscription_state AS ENUM (
    'idle',
    'executing'
);


--
-- Name: runners_update_module_name(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.runners_update_module_name() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    IF NEW.deployment_id IS NULL
    THEN
        NEW.module_name = NULL;
    ELSE
        SELECT m.name
        INTO NEW.module_name
        FROM modules m
                 INNER JOIN deployments d on m.id = d.module_id
        WHERE d.id = NEW.deployment_id;
    END IF;
    RETURN NEW;
END;
$$;


--
-- Name: topics_update_head(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.topics_update_head() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    UPDATE topics
    SET head = (
        SELECT id
        FROM topic_events
        WHERE topic_id = NEW.topic_id
        ORDER BY created_at DESC, id DESC
        LIMIT 1
    )
    WHERE id = NEW.topic_id;
    RETURN NEW;
END;
$$;


SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: artefacts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.artefacts (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    digest bytea NOT NULL,
    content bytea NOT NULL
);


--
-- Name: artefacts_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.artefacts ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.artefacts_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: async_calls; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.async_calls (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    lease_id bigint,
    verb public.schema_ref NOT NULL,
    state public.async_call_state DEFAULT 'pending'::public.async_call_state NOT NULL,
    origin text NOT NULL,
    scheduled_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    request public.encrypted_async NOT NULL,
    response public.encrypted_async,
    error text,
    remaining_attempts integer NOT NULL,
    backoff interval NOT NULL,
    max_backoff interval NOT NULL,
    catch_verb public.schema_ref,
    catching boolean DEFAULT false NOT NULL,
    parent_request_key text,
    trace_context jsonb
);


--
-- Name: async_calls_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.async_calls ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.async_calls_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: controllers; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.controllers (
    id bigint NOT NULL,
    key public.controller_key NOT NULL,
    created timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    last_seen timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    state public.controller_state DEFAULT 'live'::public.controller_state NOT NULL,
    endpoint text NOT NULL
);


--
-- Name: controller_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.controllers ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.controller_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: cron_jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.cron_jobs (
    id bigint NOT NULL,
    key public.cron_job_key NOT NULL,
    deployment_id bigint NOT NULL,
    verb text NOT NULL,
    schedule text NOT NULL,
    start_time timestamp with time zone NOT NULL,
    next_execution timestamp with time zone NOT NULL,
    module_name text NOT NULL,
    last_execution timestamp with time zone,
    last_async_call_id bigint
);


--
-- Name: cron_jobs_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.cron_jobs ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.cron_jobs_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: deployment_artefacts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deployment_artefacts (
    artefact_id bigint NOT NULL,
    deployment_id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    executable boolean NOT NULL,
    path text NOT NULL
);


--
-- Name: deployments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deployments (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    module_id bigint NOT NULL,
    key public.deployment_key NOT NULL,
    schema public.module_schema_pb NOT NULL,
    labels jsonb DEFAULT '{}'::jsonb NOT NULL,
    min_replicas integer DEFAULT 0 NOT NULL
);


--
-- Name: deployments_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.deployments ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.deployments_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: encryption_keys; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.encryption_keys (
    id bigint NOT NULL,
    key bytea NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    verify_timeline public.encrypted_timeline,
    verify_async public.encrypted_async
);


--
-- Name: encryption_keys_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.encryption_keys ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.encryption_keys_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: timeline; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.timeline (
    id bigint NOT NULL,
    time_stamp timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    deployment_id bigint NOT NULL,
    request_id bigint,
    type public.event_type NOT NULL,
    custom_key_1 text,
    custom_key_2 text,
    custom_key_3 text,
    custom_key_4 text,
    payload public.encrypted_timeline NOT NULL,
    parent_request_id text
);


--
-- Name: events_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.timeline ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.events_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: fsm_instances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.fsm_instances (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    fsm public.schema_ref NOT NULL,
    key text NOT NULL,
    status public.fsm_status DEFAULT 'running'::public.fsm_status NOT NULL,
    current_state public.schema_ref,
    destination_state public.schema_ref,
    async_call_id bigint,
    updated_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL
);


--
-- Name: fsm_instances_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.fsm_instances ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.fsm_instances_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: fsm_next_event; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.fsm_next_event (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    fsm_instance_id bigint NOT NULL,
    next_state public.schema_ref NOT NULL,
    request public.encrypted_async NOT NULL,
    request_type public.schema_type NOT NULL
);


--
-- Name: fsm_next_event_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.fsm_next_event ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.fsm_next_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: ingress_routes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ingress_routes (
    method text NOT NULL,
    path text NOT NULL,
    deployment_id bigint NOT NULL,
    module text NOT NULL,
    verb text NOT NULL
);


--
-- Name: leases; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.leases (
    id bigint NOT NULL,
    idempotency_key uuid NOT NULL,
    key public.lease_key NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    metadata jsonb
);


--
-- Name: leases_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.leases ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.leases_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: module_configuration; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.module_configuration (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    module text,
    name text NOT NULL,
    value jsonb NOT NULL
);


--
-- Name: module_configuration_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.module_configuration ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.module_configuration_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: module_secrets; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.module_secrets (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    module text,
    name text NOT NULL,
    url text NOT NULL
);


--
-- Name: module_secrets_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.module_secrets ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.module_secrets_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: modules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.modules (
    id bigint NOT NULL,
    language text NOT NULL,
    name text NOT NULL
);


--
-- Name: modules_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.modules ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.modules_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: requests; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.requests (
    id bigint NOT NULL,
    origin public.origin NOT NULL,
    key public.request_key NOT NULL,
    source_addr text NOT NULL
);


--
-- Name: requests_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.requests ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.requests_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: runners; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.runners (
    id bigint NOT NULL,
    key public.runner_key NOT NULL,
    created timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    last_seen timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    endpoint text NOT NULL,
    module_name text,
    deployment_id bigint NOT NULL,
    labels jsonb DEFAULT '{}'::jsonb NOT NULL
);


--
-- Name: runners_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.runners ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.runners_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: schema_migrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.schema_migrations (
    version character varying(128) NOT NULL
);


--
-- Name: topic_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.topic_events (
    id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    key public.topic_event_key NOT NULL,
    topic_id bigint NOT NULL,
    payload public.encrypted_async NOT NULL,
    caller text,
    request_key text,
    trace_context jsonb
);


--
-- Name: topic_events_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.topic_events ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.topic_events_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: topic_subscribers; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.topic_subscribers (
    id bigint NOT NULL,
    key public.subscriber_key NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    topic_subscriptions_id bigint NOT NULL,
    deployment_id bigint NOT NULL,
    sink public.schema_ref NOT NULL,
    retry_attempts integer NOT NULL,
    backoff interval NOT NULL,
    max_backoff interval NOT NULL,
    catch_verb public.schema_ref
);


--
-- Name: topic_subscribers_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.topic_subscribers ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.topic_subscribers_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: topic_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.topic_subscriptions (
    id bigint NOT NULL,
    key public.subscription_key NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    topic_id bigint NOT NULL,
    module_id bigint NOT NULL,
    deployment_id bigint NOT NULL,
    name text NOT NULL,
    cursor bigint,
    state public.topic_subscription_state DEFAULT 'idle'::public.topic_subscription_state NOT NULL
);


--
-- Name: topic_subscriptions_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.topic_subscriptions ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.topic_subscriptions_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: topics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.topics (
    id bigint NOT NULL,
    key public.topic_key NOT NULL,
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL,
    module_id bigint NOT NULL,
    name text NOT NULL,
    type text NOT NULL,
    head bigint
);


--
-- Name: topics_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.topics ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.topics_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: artefacts artefacts_digest_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.artefacts
    ADD CONSTRAINT artefacts_digest_key UNIQUE (digest);


--
-- Name: artefacts artefacts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.artefacts
    ADD CONSTRAINT artefacts_pkey PRIMARY KEY (id);


--
-- Name: async_calls async_calls_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.async_calls
    ADD CONSTRAINT async_calls_pkey PRIMARY KEY (id);


--
-- Name: controllers controller_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.controllers
    ADD CONSTRAINT controller_key_key UNIQUE (key);


--
-- Name: controllers controller_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.controllers
    ADD CONSTRAINT controller_pkey PRIMARY KEY (id);


--
-- Name: cron_jobs cron_jobs_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cron_jobs
    ADD CONSTRAINT cron_jobs_key_key UNIQUE (key);


--
-- Name: cron_jobs cron_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cron_jobs
    ADD CONSTRAINT cron_jobs_pkey PRIMARY KEY (id);


--
-- Name: deployments deployments_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_key_key UNIQUE (key);


--
-- Name: deployments deployments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_pkey PRIMARY KEY (id);


--
-- Name: encryption_keys encryption_keys_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.encryption_keys
    ADD CONSTRAINT encryption_keys_pkey PRIMARY KEY (id);


--
-- Name: timeline events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.timeline
    ADD CONSTRAINT events_pkey PRIMARY KEY (id);


--
-- Name: fsm_instances fsm_instances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_instances
    ADD CONSTRAINT fsm_instances_pkey PRIMARY KEY (id);


--
-- Name: fsm_next_event fsm_next_event_fsm_instance_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_next_event
    ADD CONSTRAINT fsm_next_event_fsm_instance_id_key UNIQUE (fsm_instance_id);


--
-- Name: fsm_next_event fsm_next_event_fsm_instance_id_next_state_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_next_event
    ADD CONSTRAINT fsm_next_event_fsm_instance_id_next_state_key UNIQUE (fsm_instance_id, next_state);


--
-- Name: fsm_next_event fsm_next_event_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_next_event
    ADD CONSTRAINT fsm_next_event_pkey PRIMARY KEY (id);


--
-- Name: fsm_instances idx_fsm_instances_fsm_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_instances
    ADD CONSTRAINT idx_fsm_instances_fsm_key UNIQUE (fsm, key);


--
-- Name: leases leases_idempotency_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leases
    ADD CONSTRAINT leases_idempotency_key_key UNIQUE (idempotency_key);


--
-- Name: leases leases_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leases
    ADD CONSTRAINT leases_key_key UNIQUE (key);


--
-- Name: leases leases_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leases
    ADD CONSTRAINT leases_pkey PRIMARY KEY (id);


--
-- Name: module_configuration module_configuration_module_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_configuration
    ADD CONSTRAINT module_configuration_module_name_key UNIQUE (module, name);


--
-- Name: module_configuration module_configuration_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_configuration
    ADD CONSTRAINT module_configuration_pkey PRIMARY KEY (id);


--
-- Name: module_secrets module_secrets_module_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_secrets
    ADD CONSTRAINT module_secrets_module_name_key UNIQUE (module, name);


--
-- Name: module_secrets module_secrets_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_secrets
    ADD CONSTRAINT module_secrets_pkey PRIMARY KEY (id);


--
-- Name: modules modules_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.modules
    ADD CONSTRAINT modules_name_key UNIQUE (name);


--
-- Name: modules modules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.modules
    ADD CONSTRAINT modules_pkey PRIMARY KEY (id);


--
-- Name: requests requests_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.requests
    ADD CONSTRAINT requests_key_key UNIQUE (key);


--
-- Name: requests requests_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.requests
    ADD CONSTRAINT requests_pkey PRIMARY KEY (id);


--
-- Name: runners runners_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.runners
    ADD CONSTRAINT runners_key_key UNIQUE (key);


--
-- Name: runners runners_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.runners
    ADD CONSTRAINT runners_pkey PRIMARY KEY (id);


--
-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.schema_migrations
    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);


--
-- Name: topic_events topic_events_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_events
    ADD CONSTRAINT topic_events_key_key UNIQUE (key);


--
-- Name: topic_events topic_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_events
    ADD CONSTRAINT topic_events_pkey PRIMARY KEY (id);


--
-- Name: topic_subscribers topic_subscribers_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscribers
    ADD CONSTRAINT topic_subscribers_key_key UNIQUE (key);


--
-- Name: topic_subscribers topic_subscribers_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscribers
    ADD CONSTRAINT topic_subscribers_pkey PRIMARY KEY (id);


--
-- Name: topic_subscriptions topic_subscriptions_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_key_key UNIQUE (key);


--
-- Name: topic_subscriptions topic_subscriptions_module_name_idx; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_module_name_idx UNIQUE (module_id, name);


--
-- Name: topic_subscriptions topic_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: topics topics_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topics
    ADD CONSTRAINT topics_key_key UNIQUE (key);


--
-- Name: topics topics_module_name_idx; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topics
    ADD CONSTRAINT topics_module_name_idx UNIQUE (module_id, name);


--
-- Name: topics topics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topics
    ADD CONSTRAINT topics_pkey PRIMARY KEY (id);


--
-- Name: async_calls_state_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX async_calls_state_idx ON public.async_calls USING btree (state);


--
-- Name: controller_endpoint_not_dead_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX controller_endpoint_not_dead_idx ON public.controllers USING btree (endpoint) WHERE (state <> 'dead'::public.controller_state);


--
-- Name: deployment_artefacts_deployment_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX deployment_artefacts_deployment_id_idx ON public.deployment_artefacts USING btree (deployment_id);


--
-- Name: deployments_active_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX deployments_active_idx ON public.deployments USING btree (module_id) WHERE (min_replicas > 0);


--
-- Name: deployments_module_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX deployments_module_id_idx ON public.deployments USING btree (module_id);


--
-- Name: events_custom_key_1_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_custom_key_1_idx ON public.timeline USING btree (custom_key_1);


--
-- Name: events_custom_key_2_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_custom_key_2_idx ON public.timeline USING btree (custom_key_2);


--
-- Name: events_custom_key_3_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_custom_key_3_idx ON public.timeline USING btree (custom_key_3);


--
-- Name: events_custom_key_4_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_custom_key_4_idx ON public.timeline USING btree (custom_key_4);


--
-- Name: events_deployment_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_deployment_id_idx ON public.timeline USING btree (deployment_id);


--
-- Name: events_request_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_request_id_idx ON public.timeline USING btree (request_id);


--
-- Name: events_timestamp_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_timestamp_idx ON public.timeline USING btree (time_stamp);


--
-- Name: events_type_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX events_type_idx ON public.timeline USING btree (type);


--
-- Name: idx_fsm_instances_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_fsm_instances_status ON public.fsm_instances USING btree (status);


--
-- Name: ingress_routes_method_path_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ingress_routes_method_path_idx ON public.ingress_routes USING btree (method, path);


--
-- Name: leases_expires_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX leases_expires_at_idx ON public.leases USING btree (expires_at);


--
-- Name: module_config_name_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX module_config_name_unique ON public.module_configuration USING btree (COALESCE(module, ''::text), name);


--
-- Name: module_secret_name_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX module_secret_name_unique ON public.module_secrets USING btree (COALESCE(module, ''::text), name);


--
-- Name: requests_origin_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX requests_origin_idx ON public.requests USING btree (origin);


--
-- Name: runners_deployment_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX runners_deployment_id_idx ON public.runners USING btree (deployment_id);


--
-- Name: runners_labels_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX runners_labels_idx ON public.runners USING gin (labels);


--
-- Name: runners_module_name_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX runners_module_name_idx ON public.runners USING btree (module_name);


--
-- Name: topic_events_topic_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX topic_events_topic_idx ON public.topic_events USING btree (topic_id);


--
-- Name: topic_subscribers_subscription_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX topic_subscribers_subscription_idx ON public.topic_subscribers USING btree (topic_subscriptions_id);


--
-- Name: topics_key_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX topics_key_idx ON public.topics USING btree (key);


--
-- Name: runners runners_update_module_name; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER runners_update_module_name BEFORE INSERT OR UPDATE ON public.runners FOR EACH ROW EXECUTE FUNCTION public.runners_update_module_name();


--
-- Name: topic_events topics_update_head; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER topics_update_head AFTER INSERT OR UPDATE ON public.topic_events FOR EACH ROW EXECUTE FUNCTION public.topics_update_head();


--
-- Name: async_calls async_calls_lease_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.async_calls
    ADD CONSTRAINT async_calls_lease_id_fkey FOREIGN KEY (lease_id) REFERENCES public.leases(id) ON DELETE SET NULL;


--
-- Name: cron_jobs cron_jobs_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cron_jobs
    ADD CONSTRAINT cron_jobs_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE CASCADE;


--
-- Name: deployment_artefacts deployment_artefacts_artefact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deployment_artefacts
    ADD CONSTRAINT deployment_artefacts_artefact_id_fkey FOREIGN KEY (artefact_id) REFERENCES public.artefacts(id) ON DELETE CASCADE;


--
-- Name: deployment_artefacts deployment_artefacts_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deployment_artefacts
    ADD CONSTRAINT deployment_artefacts_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE CASCADE;


--
-- Name: deployments deployments_module_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_module_id_fkey FOREIGN KEY (module_id) REFERENCES public.modules(id) ON DELETE CASCADE;


--
-- Name: timeline events_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.timeline
    ADD CONSTRAINT events_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE CASCADE;


--
-- Name: timeline events_request_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.timeline
    ADD CONSTRAINT events_request_id_fkey FOREIGN KEY (request_id) REFERENCES public.requests(id) ON DELETE CASCADE;


--
-- Name: cron_jobs fk_cron_jobs_last_async_call_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cron_jobs
    ADD CONSTRAINT fk_cron_jobs_last_async_call_id FOREIGN KEY (last_async_call_id) REFERENCES public.async_calls(id) ON DELETE SET NULL;


--
-- Name: fsm_instances fsm_instances_async_call_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_instances
    ADD CONSTRAINT fsm_instances_async_call_id_fkey FOREIGN KEY (async_call_id) REFERENCES public.async_calls(id);


--
-- Name: fsm_next_event fsm_next_event_fsm_instance_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.fsm_next_event
    ADD CONSTRAINT fsm_next_event_fsm_instance_id_fkey FOREIGN KEY (fsm_instance_id) REFERENCES public.fsm_instances(id) ON DELETE CASCADE;


--
-- Name: ingress_routes ingress_routes_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ingress_routes
    ADD CONSTRAINT ingress_routes_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE CASCADE;


--
-- Name: runners runners_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.runners
    ADD CONSTRAINT runners_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE SET NULL;


--
-- Name: topic_events topic_events_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_events
    ADD CONSTRAINT topic_events_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.topics(id) ON DELETE CASCADE;


--
-- Name: topic_subscribers topic_subscribers_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscribers
    ADD CONSTRAINT topic_subscribers_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE CASCADE;


--
-- Name: topic_subscribers topic_subscribers_topic_subscriptions_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscribers
    ADD CONSTRAINT topic_subscribers_topic_subscriptions_id_fkey FOREIGN KEY (topic_subscriptions_id) REFERENCES public.topic_subscriptions(id) ON DELETE CASCADE;


--
-- Name: topic_subscriptions topic_subscriptions_cursor_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_cursor_fkey FOREIGN KEY (cursor) REFERENCES public.topic_events(id) ON DELETE CASCADE;


--
-- Name: topic_subscriptions topic_subscriptions_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id);


--
-- Name: topic_subscriptions topic_subscriptions_module_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_module_id_fkey FOREIGN KEY (module_id) REFERENCES public.modules(id);


--
-- Name: topic_subscriptions topic_subscriptions_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_subscriptions
    ADD CONSTRAINT topic_subscriptions_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.topics(id) ON DELETE CASCADE;


--
-- Name: topics topics_module_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topics
    ADD CONSTRAINT topics_module_id_fkey FOREIGN KEY (module_id) REFERENCES public.modules(id);


--
-- PostgreSQL database dump complete
--


--
-- Dbmate schema migrations
--

INSERT INTO public.schema_migrations (version) VALUES
    ('20231103205514'),
    ('20240704103403'),
    ('20240725212023'),
    ('20240729002557'),
    ('20240731230343'),
    ('20240801160101'),
    ('20240807174508'),
    ('20240812011321'),
    ('20240813062546'),
    ('20240814060154'),
    ('20240815003340'),
    ('20240815053106'),
    ('20240815164808'),
    ('20240820011612'),
    ('20240902030242'),
    ('20240903043046'),
    ('20240913035022'),
    ('20240913041619'),
    ('20240916015906'),
    ('20240916190209'),
    ('20240917015216'),
    ('20240917062716');
