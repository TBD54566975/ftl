{% extends "adidoks/templates/base.html" %}
{% block footer %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", inject);

function inject() {
  document.querySelectorAll(".code-selector").forEach(injectTabs);
}

function injectTabs(codeSelector) {
  console.log("Injecting tabs for", codeSelector);

  const nav = codeSelector.querySelector("ul.nav");

  let langs = [];
  let tabs = [];
  let currentLang = null;
  codeSelector.childNodes.forEach((element) => {
    let toAdd = null;

    if (element.nodeType === Node.COMMENT_NODE) {
      // if its a comment like <!-- go -->, then set the currentLang to go and add it to langs
      // end will cancel the currentLang, so you can continue to write common documentation.
      const lang = element.data.trim();
      if (lang === "end") {
        currentLang = null;
      } else {
        currentLang = lang;
        toAdd = { lang, element };
      }
    } else if (element.tagName === "PRE") {
      // pre with data-lang attribute
      const lang = element.getAttribute("data-lang");
      // code blocks reset the currentLang.
      currentLang = null;
      toAdd = { lang, element };
    } else if (currentLang) {
      // if we are in a currentLang, then add the element to it.
      toAdd = { lang: currentLang, element };
    }

    if (!toAdd) {
      return;
    }

    langs.push(toAdd);
    if (tabs.indexOf(toAdd.lang) === -1) {
      tabs.push(toAdd.lang);
    }
  });

  console.log("xxx Languages found", langs);

  // Let us put this in the codeSelector element, so that we later check if the new selected language is in the list first.
  codeSelector.langs = langs;

  let saved = localStorage.getItem("code-lang");
  let selected = tabs[0];
  if (saved) {
    console.log("Saved language", saved);
    console.log("Languages", langs);

    // Only select the saved language if it's in the list.
    found = tabs.find((lang) => lang === saved);
    if (found) {
      selected = found;
    }
  }

  console.log("Selected language", selected);
  for (const lang of tabs) {
    console.log("Adding tab for", lang);
    const isSelected = selected === lang;
    console.log("Is selected", isSelected);

    const li = document.createElement("li");
    li.classList.add("nav-item");

    const a = document.createElement("a");
    a.classList.add("nav-link");
    if (isSelected) {
      a.classList.add("active");
      a.setAttribute("aria-current", "page");
    }

    a.href = "#";
    a.textContent = capitalize(lang);
    a.lang = lang;

    a.addEventListener("click", (e) => {
      e.preventDefault();
      changeLanguage(lang);
    });

    li.appendChild(a);
    nav.appendChild(li);
  }

  for (const { lang, element } of langs) {
    const isSelected = selected === lang;
    if (element.classList) {
      if (!isSelected) {
        element.classList.add("d-none");
      }
    }
  }
}

function capitalize(str) {
  return str[0].toUpperCase() + str.slice(1);
}

function changeLanguage(lang) {
  console.log("Changing language to", lang);
  localStorage.setItem("code-lang", lang);

  document.querySelectorAll(".code-selector").forEach((codeSelector) => {
    const langs = codeSelector.langs;
    if (!langs) {
      console.error("Missing langs property on codeSelector", codeSelector);
      return;
    }

    const selected = langs.find((l) => l.lang === lang);
    if (!selected) {
      // This tab group doesn't have the selected language--all good.
      return;
    }

    // Show/hide each element within the codeSelector
    langs.forEach((l) => {
      console.log("Setting display", l, selected, l.lang === selected.lang);
      // l.element.style.display = l.lang === selected.lang ? "block" : "none";
      // addClass and removeClass bootstrap classes

      if (l.element.classList) {
        if (l.lang === selected.lang) {
          l.element.classList.remove("d-none");
        } else {
          l.element.classList.add("d-none");
        }
      }
    });

    // Update the active tab
    codeSelector.querySelectorAll("a.nav-link").forEach((a) => {
      a.classList.remove("active");
      a.removeAttribute("aria-current");
      if (a.lang === lang) {
        a.classList.add("active");
        a.setAttribute("aria-current", "page");
      }
    });
  });
}

</script>
{% endblock %}
