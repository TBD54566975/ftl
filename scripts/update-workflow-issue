#!/bin/bash

list_issues() {
  gh issue list "$@" --json number --jq 'map("- #\(.number)")[]' | sort -n
}

list_prs() {
  gh pr list "$@" --json number --jq 'map("- #\(.number)")[]' | sort -n
}

list_issues_and_prs() {
  user="$1"
  shift
  (gh pr list -A "$user" "$@" --json number,mergedAt | jq '[.[] | .["closedAt"] = .mergedAt | del(.mergedAt)]'; gh issue list -a "$user" "$@" --json number,closedAt) | jq '.[]' | jq -rs 'sort_by(.closedAt) | reverse | map("- #\(.number)")[]'
}

update() {
  if test -z "$NOOP"; then
    gh issue edit -F - 728
  else
    cat
  fi
}

update <<EOF
<!-- This file is generated by scripts/update-workflow-issue. Do not edit manually. -->

$(
  issues="$(list_issues --label urgent)"
  test -z "$issues" && exit 0

  echo "### https://github.com/TBD54566975/ftl/labels/urgent"
  echo
  echo "> [!WARNING]"
  echo "> These issues are urgent and need immediate attention."
  echo "$issues"
)

### Active and recent issues

$(

if [ "$(uname -o)" = "GNU/Linux" ]; then
  date="$(date -d "- 5 days" +%Y-%m-%d)"
else
  date="$(date -v "-5d" +%Y-%m-%d)"
fi

gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /orgs/TBD54566975/teams/ftl-team/members | jq -r '.[].login' | grep -v dhanji | sort | while read -r member; do
  echo "@$member [ðŸ”Ž](https://github.com/TBD54566975/ftl/issues/assigned/$member)"
  echo
  list_issues_and_prs "$member"
  list_issues_and_prs "$member" -s closed -S "closed:>$date"
  echo
done
)

$(
  issues="$(list_issues --label triage)"
  test -z "$issues" && exit 0

  echo "### https://github.com/TBD54566975/ftl/labels/triage"
  echo
  echo "$issues"
)

### https://github.com/TBD54566975/ftl/labels/next

$(
  issues="$(list_issues --label next)"
  if test -z "$issues"; then
    echo "> [!WARNING]"
    echo "> There are no issues labelled for upcoming work."
    exit 0
  fi
  echo "$issues"
)

$(
  issues="$(list_issues --label epic)"
  test -z "$issues" && exit 0

  echo "### https://github.com/TBD54566975/ftl/labels/epic"
  echo "$issues"
)

EOF