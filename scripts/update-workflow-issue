#!/bin/bash

list_issues() {
  gh issue list "$@" --json number --jq 'map("- #\(.number)")[]' | sort -n
}

gh issue edit -F - 728 <<EOF
<!-- This file is generated by scripts/update-workflow-issue. Do not edit manually. -->

$(
  issues="$(list_issues --label urgent)"
  test -z "$issues" && exit 0


  echo "### Urgent [ðŸ‘€](https://github.com/TBD54566975/ftl/issues?q=is%3Aissue+is%3Aopen+label%3Aurgent)"
  echo
  echo "> [!WARNING]"
  echo "> These issues are urgent and need immediate attention."
  echo "$issues"
)

### Current assigned issues

$(
gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /orgs/TBD54566975/teams/ftl-team/members | jq -r '.[].login' | grep -v dhanji | sort | while read -r member; do
  echo "@$member [ðŸ‘€](https://github.com/TBD54566975/ftl/issues/assigned/$member)"
  echo
  list_issues -a "$member"
  echo
done
)

$(
  issues="$(list_issues --label triage)"
  test -z "$issues" && exit 0

  echo "### Need triage [ðŸ‘€](https://github.com/TBD54566975/ftl/issues?q=is%3Aissue+is%3Aopen+label%3Atriage)"
  echo
  echo "$issues"
)

### Next [ðŸ‘€](https://github.com/TBD54566975/ftl/issues?q=is%3Aissue+is%3Aopen+label%3Anext)

$(
  issues="$(list_issues --label next)"
  if test -z "$issues"; then
    echo "> [!WARNING]"
    echo "> There are no issues labelled for upcoming work."
    exit 0
  fi
  echo "$issues"
)
EOF