#!/bin/bash
set -euo pipefail

function deps() {
  go list -f '{{range .Deps}}{{.}}
{{end}}
' "$1" | grep ^github.com/TBD54566975/ftl | cut -d/ -f4- | tr '\n' '|' | sed 's,|$,,'
}

cat <<EOF > reflex.conf
# Generated file. DO NOT MODIFY

# sqlc regeneration
-r '(sqlc.yaml|controller/internal/sql/queries\.sql|controller/internal/sql/schema/.*\.sql|protos/xyz/block/ftl/v1/ftl\.proto)$' \
-- make generate

# Control Plane
-s \\
-r '($(deps ./cmd/ftl-controller))/[^/]*\.go$' \\
-- ftl-controller --key C01H5BRT09Y07547SETZ4HWRA09 $@

# Runner 1
-s \\
-r '($(deps ./cmd/ftl-runner))/[^/]*\.go$' \\
-- ftl-runner --key R01H5BTS6ABP1EHGZSAGJMBV50A --language go --endpoint http://localhost:8894 $@

# Runner 2
-s \\
-r '($(deps ./cmd/ftl-runner))/[^/]*\.go$' \\
-- ftl-runner --key R01H5BTSGKQ8AZ9S22N9N1SM9HV --language go --endpoint http://localhost:8895 $@
EOF

reflex -s -d none -g reflex.conf -- reflex -d fancy -c reflex.conf
