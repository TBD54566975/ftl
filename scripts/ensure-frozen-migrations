#!/bin/bash
set -euo pipefail

# echo
set -x

# This script checks if the SQL migration have been modified compared to the common ancestor with the main branch.
# It ignores comments when comparing the files.

remove_comments() {
    sed 's/[[:space:]]*--.*$//g' "$1"
}

compare_sql_files() {
    local file1="$1"
    local file2="$2"
    diff -q <(remove_comments "$file1" | sed '/^\s*$/d' | sort) \
            <(remove_comments "$file2" | sed '/^\s*$/d' | sort) > /dev/null
}

show_diff() {
    local file1="$1"
    local file2="$2"
    diff -u <(remove_comments "$file1") <(remove_comments "$file2")
}

main() {
    local sql_dir="backend/controller/sql/schema"
    local changed_files
    local merge_base

    # Find the merge base commit
    merge_base=$(git merge-base HEAD origin/main)

    # Get list of changed SQL files compared to the merge base
    changed_files=$(git diff --name-only "$merge_base" -- "$sql_dir"/*.sql)

    if [ -z "$changed_files" ]; then
        echo "👍 No SQL files changed in $sql_dir compared to the common ancestor with main branch"
        exit 0
    fi

    while IFS= read -r file; do
        if [ ! -f "$file" ]; then
            echo "$file no longer exists!"
            exit 1
        fi
        if compare_sql_files "$file" <(git show "$merge_base:$file"); then
            : # Do nothing if files are the same
        else
            echo "❌ Migration files changes detected"
            show_diff "$file" <(git show "$merge_base:$file")
            exit 1
        fi
    done <<< "$changed_files"

    git diff --color=always "$merge_base" -- "$sql_dir"/*.sql | cat
    echo "👍 Only comments/new lines changed in SQL files"
}

# Run the main function
main